# Tesseract Collective User Authentication Service

Features:
- email/password account creation
- email/password login
- email verification
- mobile phone verification
- password reset via email
- JWTs and authentication

TODO:
-[ ] Refresh tokens (currently JWTs don't expire)

## API Docs

- OpenAPI 3.0 Schema: docs/schema.yaml
- Swagger Docs: https://tesseractcollective.github.io/user-authentication-service/index.html

## Instructions to deploy:

### 1. Install dependencies:

```bash
# yarn
yarn install
```

```bash
# npm
npm install
```

### 2. Setup AWS CLI and admin access keys:
- Install CLI: https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html
- Setup CLI: https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html
- Additional serverless.com reference: https://www.serverless.com/framework/docs/providers/aws/guide/credentials/

### 3. Setup secrets:

The script stores the secrets in the AWS Secrets Manager (SSM). It will prompt for either `dev` or `prod` secrets. It will also auto-generate secrets for you using `crypto.randomBytes` encoded as base64. Just hit enter to use the auto-generated secret, or provide your own.

Secrets include:
- JWT HM256 signing key

```bash
# yarn
yarn setup:secrets
```

```bash
# npm
npm run setup:secrets
```

### 4. Setup AWS SES (email):
- Verify domain(s) you will be emailing from: https://docs.aws.amazon.com/ses/latest/DeveloperGuide/mail-from.html
- Move out of sandbox: https://docs.aws.amazon.com/ses/latest/DeveloperGuide/quick-start.html

### 5. AWS configuration and CloudFormation

AWS configuration is managed by the Serverless Framework (serverless.com). The configuration for this project is in the file `serverless.yaml`. The Serverless Framework uses this file to create CloudFormation templates including setting up all the necessary IAM roles and permissions. (You can see the generated CloudFormation templates after deployment in the `.serverless/` directory). To aid the setup, `serverless.yaml` also references the configuration generated by `serverlessConfig.js`. 

### 6. Deploy:

```bash
# yarn
yarn deploy # or `yarn deploy:prod`
```

```bash
# npm
npm run deploy # or `npm run deploy:prod`
```

### 7. Run locally:
- NOTE: running locally requires a deploy first because we haven't yet included mocks for DynamoDB, SES (email), or SNS (SMS messages).
- You can test all the endpoints by importing the OpenAPI 3.0 schema found in docs/schema.yaml into a HTTP client like postman. 

```bash
# yarn
yarn start
```

```bash
# npm
npm start
```
